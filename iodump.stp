global outbuf

function buflog (msg:string) {
  printf("%s", msg)
  outbuf = outbuf . msg
}

#probe module("sd_mod").function("sd_init_command") {
probe module("sd_mod").function("sd_prep_fn") {

  if ($rq->cmd_flags /* cmd_flags on some kernels */ & 1)
    read_or_write = "w"
  else
    read_or_write = "r"

  printf("timestamp,hostname,scsi_id,%s,%s,%d,%d\n", "CIAO", read_or_write, $rq->sector, $rq->nr_sectors)
#  printf("timestamp,hostname,scsi_id,%s,%s,%d,%d,%d\n", "CIAO", read_or_write, $rq->sector, $sdp->sector_size, $rq->nr_sectors)

#  printf("timestamp,hostname,scsi_id,%s,%s,%d,%d,%d\n", $rq->rq_disk->disk_name, read_or_write, $rq->sector, $sdp->sector_size, $rq->nr_sectors)
#  msg = sprintf("timestamp,hostname,scsi_id,%s,%s,%d,%d,%d\n", $SCpnt->request->rq_disk->disk_name, read_or_write, $SCpnt->request->sector, $SCpnt->device->sector_size, $SCpnt->request->nr_sectors)
#  buflog(msg)
#  delete msg
#  delete read_or_write */

}

probe begin {
  outbuf = "# timestamp,hostname,scsi_id,disk,operation,block,sectors,sector_size\n"
}

probe end {
  printf("%s", msg)
}
